(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{639:function(e,t,n){"use strict";var o=n(47),r=n(6);const l={};function c(e,t,n){return e.on(t,n)}l.obj=function(param){return param},l.supportsImageRenderingPixelatedResult_=void 0,l.imageRenderingValueResult_=void 0,l.supportsImageRenderingPixelated=function(){if(void 0===l.supportsImageRenderingPixelatedResult_){const canvas=document.createElement("canvas");canvas.setAttribute("style","image-rendering: -moz-crisp-edges; image-rendering: pixelated;");const e=canvas.style.imageRendering;l.supportsImageRenderingPixelatedResult_=!!e,l.supportsImageRenderingPixelatedResult_&&(l.imageRenderingValueResult_=e)}return l.supportsImageRenderingPixelatedResult_},l.imageRenderingValue=function(){return l.supportsImageRenderingPixelated(),l.imageRenderingValueResult_||""},l.getSourceProjection=function(source){return source.get("olcs.projection")||source.getProjection()};let h=0;function m(e){return e.olcs_uid||(e.olcs_uid=++h)}function d(e){const t=Cesium.GroundPolylinePrimitive;return t&&t.isSupported(e)}var C=l,_=n(36),y=n(160),f=n(173),v=n(255),w=n(256),S=n(57),P=n(257),L=n(52);class T{constructor(e,source,t){this.source_=source,this.projection_=null,this.fallbackProj_=t||null,this.ready_=!1,this.tilingScheme_=null,this.rectangle_=null,this.map_=e;const n=this.source_.get("olcs.proxy");n&&("function"==typeof n?this.proxy_={getURL:n}:"string"==typeof n&&(this.proxy_=new Cesium.DefaultProxy(n))),this.errorEvent_=new Cesium.Event,this.emptyCanvas_=document.createElement("canvas"),this.emptyCanvas_.width=1,this.emptyCanvas_.height=1,this.source_.on("change",e=>{this.handleSourceChanged_()}),this.handleSourceChanged_()}handleSourceChanged_(e){if(!this.ready_&&"ready"==this.source_.getState()){if(this.projection_=C.getSourceProjection(this.source_)||this.fallbackProj_,this.projection_==Object(r.get)("EPSG:4326"))this.tilingScheme_=new Cesium.GeographicTilingScheme;else{if(this.projection_!=Object(r.get)("EPSG:3857"))return;this.tilingScheme_=new Cesium.WebMercatorTilingScheme}this.rectangle_=this.tilingScheme_.rectangle,this.ready_=!0}}getTileCredits(e,t,n){const o=this.map_.getView().calculateExtent(this.map_.getSize()),r=this.map_.getView().getCenter(),l={viewState:{zoom:this.tilingScheme_ instanceof Cesium.GeographicTilingScheme?n+1:n,center:r},extent:o},c=this.source_.getAttributions();if(!c)return[];let h=c(l);return Array.isArray(h)||(h=[h]),h.map(html=>new Cesium.Credit(html,!0))}requestImage(e,t,n){const o=this.source_.getTileUrlFunction();if(o&&this.projection_){const r=this.tilingScheme_ instanceof Cesium.GeographicTilingScheme?n+1:n,l=-t-1;let c=o.call(this.source_,[r,e,l],1,this.projection_);return this.proxy_&&(c=this.proxy_.getURL(c)),c?Cesium.ImageryProvider.loadImage(this,c):this.emptyCanvas_}return this.emptyCanvas_}}Object.defineProperties(T.prototype,{ready:{get:function(){return this.ready_}},rectangle:{get:function(){return this.rectangle_}},tileWidth:{get:function(){const e=this.source_.getTileGrid();return e?Array.isArray(e.getTileSize(0))?e.getTileSize(0)[0]:e.getTileSize(0):256}},tileHeight:{get:function(){const e=this.source_.getTileGrid();return e?Array.isArray(e.getTileSize(0))?e.getTileSize(0)[1]:e.getTileSize(0):256}},maximumLevel:{get:function(){const e=this.source_.getTileGrid();return e?e.getMaxZoom():18}},minimumLevel:{get:function(){return 0}},tilingScheme:{get:function(){return this.tilingScheme_}},tileDiscardPolicy:{get:function(){}},errorEvent:{get:function(){return this.errorEvent_}},proxy:{get:function(){return this.proxy_}},hasAlphaChannel:{get:function(){return!0}},pickFeatures:{get:function(){}}});var R=T;const E={computePixelSizeAtCoordinate:function(e,t){const n=e.camera,canvas=e.canvas,o=n.frustum,r=Cesium.Cartesian3.magnitude(Cesium.Cartesian3.subtract(n.position,t,new Cesium.Cartesian3)),l=new Cesium.Cartesian2;return o.getPixelDimensions(canvas.clientWidth,canvas.clientHeight,r,l)},computeBoundingBoxAtTarget:function(e,t,n){const o=E.computePixelSizeAtCoordinate(e,t),r=Cesium.Transforms.eastNorthUpToFixedFrame(t),l=Cesium.Matrix4.multiplyByPoint(r,new Cesium.Cartesian3(-o.x*n,-o.y*n,0),new Cesium.Cartesian3),c=Cesium.Matrix4.multiplyByPoint(r,new Cesium.Cartesian3(o.x*n,o.y*n,0),new Cesium.Cartesian3);return Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray([l,c])},applyHeightOffsetToGeometry:function(e,t){e.applyTransform((input,output,e)=>{if(console.assert(input===output),void 0!==e&&e>=3)for(let i=0;i<output.length;i+=e)output[i+2]=output[i+2]+t;return output})},createMatrixAtCoordinates:function(e,t=0,n=Cesium.Cartesian3.ZERO,o=new Cesium.Cartesian3(1,1,1)){const r=E.ol4326CoordinateToCesiumCartesian(e),l=Cesium.Transforms.eastNorthUpToFixedFrame(r),c=Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Z,-t),h=Cesium.Matrix4.fromTranslationQuaternionRotationScale(n,c,o);return Cesium.Matrix4.multiply(l,h,new Cesium.Matrix4)},rotateAroundAxis:function(e,t,n,o,r){const l=Cesium.Math.clamp,c=Cesium.defaultValue,h=r||{},m=c(h.duration,500),d=c(h.easing,_.d),C=h.callback;let y=0;const f=new Cesium.Matrix4,v=Date.now(),w=function(){const r=Date.now(),progress=d(l((r-v)/m,0,1));console.assert(progress>=y),e.transform.clone(f);const c=(progress-y)*t;y=progress,e.lookAtTransform(o),e.rotate(n,c),e.lookAtTransform(f),progress<1?window.requestAnimationFrame(w):C&&C()};window.requestAnimationFrame(w)},setHeadingUsingBottomCenter:function(e,t,n,o){const r=e.camera,l=E.computeAngleToZenith(e,n),c=r.right,h=Cesium.Quaternion.fromAxisAngle(c,l),m=Cesium.Matrix3.fromQuaternion(h),d=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r.position,n,d);const C=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(m,d,C),Cesium.Cartesian3.add(C,n,C);const _=Cesium.Matrix4.fromTranslation(C);(0,E.rotateAroundAxis)(r,t,C,_,o)},pickOnTerrainOrEllipsoid:function(e,t){const n=e.camera.getPickRay(t);return e.globe.pick(n,e)||e.camera.pickEllipsoid(t)},pickBottomPoint:function(e){const canvas=e.canvas,t=new Cesium.Cartesian2(canvas.clientWidth/2,canvas.clientHeight);return E.pickOnTerrainOrEllipsoid(e,t)},pickCenterPoint:function(e){const canvas=e.canvas,t=new Cesium.Cartesian2(canvas.clientWidth/2,canvas.clientHeight/2);return E.pickOnTerrainOrEllipsoid(e,t)},computeSignedTiltAngleOnGlobe:function(e){const t=e.camera,n=new Cesium.Ray(t.position,t.direction);let o=e.globe.pick(n,e);if(!o){const e=Cesium.Ellipsoid.WGS84,t=Cesium.IntersectionTests.rayEllipsoid(n,e);t&&(o=Cesium.Ray.getPoint(n,t.start))}if(!o)return;const r=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(o,r);const l=(0,E.signedAngleBetween)(t.direction,r,t.right)-Math.PI;return Cesium.Math.convertLongitudeRange(l)},bottomFovRay:function(e){const t=e.camera,n=t.frustum.fovy/2,o=t.direction,r=Cesium.Quaternion.fromAxisAngle(t.right,n),l=Cesium.Matrix3.fromQuaternion(r),c=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(l,o,c),new Cesium.Ray(t.position,c)},signedAngleBetween:function(e,t,n){const a=new Cesium.Cartesian3,b=new Cesium.Cartesian3,o=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,a),Cesium.Cartesian3.normalize(t,b),Cesium.Cartesian3.cross(a,b,o);const r=Cesium.Cartesian3.dot(a,b),l=Cesium.Cartesian3.magnitude(o),c=Cesium.Cartesian3.dot(n,o),h=Math.atan2(l,r);return c>=0?h:-h},computeAngleToZenith:function(e,t){const n=e.camera,o=n.frustum.fovy/2,r=E.bottomFovRay(e),l=Cesium.Cartesian3.clone(r.direction);Cesium.Cartesian3.negate(l,l);const c=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,c);const h=new Cesium.Cartesian3;return Cesium.Cartesian3.negate(n.right,h),E.signedAngleBetween(c,l,h)+o},extentToRectangle:function(e,t){if(e&&t){const n=Object(r.transformExtent)(e,t,"EPSG:4326");return Cesium.Rectangle.fromDegrees(n[0],n[1],n[2],n[3])}return null},tileLayerToImageryLayer:function(e,t,n){if(!(t instanceof y.a||t instanceof f.a))return null;let o=null,source=t.getSource();if(source instanceof w.a&&source.getUrl()&&source.getImageLoadFunction()===L.b){const e={"olcs.proxy":source.get("olcs.proxy"),"olcs.extent":source.get("olcs.extent"),"olcs.projection":source.get("olcs.projection"),"olcs.imagesource":source};(source=new P.a({url:source.getUrl(),attributions:source.getAttributions(),projection:source.getProjection(),params:source.getParams()})).setProperties(e)}if(source instanceof S.a){let t=C.getSourceProjection(source);if(t||(t=n),!E.isCesiumProjection(t))return null;o=new R(e,source,n)}else{if(!(source instanceof v.a))return null;{let e=C.getSourceProjection(source);if(e||(e=n),!E.isCesiumProjection(e))return null;o=new Cesium.SingleTileImageryProvider({url:source.getUrl(),rectangle:new Cesium.Rectangle.fromDegrees(source.getImageExtent()[0],source.getImageExtent()[1],source.getImageExtent()[2],source.getImageExtent()[3])})}}const r={},l=t.get("olcs.extent")||t.getExtent();return l&&(r.rectangle=E.extentToRectangle(l,n)),new Cesium.ImageryLayer(o,r)},updateCesiumLayerProperties:function(e,t){let n=1,o=!0;[e.layer].concat(e.parents).forEach(e=>{const t=e.getOpacity();void 0!==t&&(n*=t);const r=e.getVisible();void 0!==r&&(o&=r)}),t.alpha=n,t.show=o},ol4326CoordinateToCesiumCartesian:function(e){const t=e;return t.length>2?Cesium.Cartesian3.fromDegrees(t[0],t[1],t[2]):Cesium.Cartesian3.fromDegrees(t[0],t[1])},ol4326CoordinateArrayToCsCartesians:function(e){console.assert(null!==e);const t=E.ol4326CoordinateToCesiumCartesian,n=[];for(let i=0;i<e.length;++i)n.push(t(e[i]));return n},olGeometryCloneTo4326:function(e,t){console.assert(t);const n=Object(r.get)("EPSG:4326"),o=Object(r.get)(t);if(o!==n){const t=e.getProperties();(e=e.clone()).transform(o,n),e.setProperties(t)}return e},convertColorToCesium:function(e){if(e=e||"black",Array.isArray(e))return new Cesium.Color(Cesium.Color.byteToFloat(e[0]),Cesium.Color.byteToFloat(e[1]),Cesium.Color.byteToFloat(e[2]),e[3]);if("string"==typeof e)return Cesium.Color.fromCssColorString(e);if(e instanceof CanvasPattern||e instanceof CanvasGradient){const canvas=document.createElement("canvas"),t=canvas.getContext("2d");return canvas.width=canvas.height=256,t.fillStyle=e,t.fillRect(0,0,canvas.width,canvas.height),new Cesium.ImageMaterialProperty({image:canvas})}console.assert(!1,"impossible")},convertUrlToCesium:function(e){let t="";const n=/\{(\d|[a-z])-(\d|[a-z])\}/,o=n.exec(e);if(o){e=e.replace(n,"{s}");const r=o[1].charCodeAt(0),l=o[2].charCodeAt(0);let c;for(c=r;c<=l;++c)t+=String.fromCharCode(c)}return{url:e,subdomains:t}},resetToNorthZenith:function(map,e){return new Promise((t,n)=>{const o=e.camera,r=E.pickBottomPoint(e);if(!r)return void n("Could not get bottom pivot");const l=map.getView().getRotation();if(void 0===l)return void n("The view is not initialized");const c=E.computeAngleToZenith(e,r);E.setHeadingUsingBottomCenter(e,l,r);const h=Cesium.Matrix4.fromTranslation(r),m=o.right,d={callback:()=>{const view=map.getView();E.normalizeView(view),t()}};E.rotateAroundAxis(o,-c,m,h,d)})},rotateAroundBottomCenter:function(e,t){return new Promise((n,o)=>{const r=e.camera,l=E.pickBottomPoint(e);if(!l)return void o("could not get bottom pivot");const c={callback:n},h=Cesium.Matrix4.fromTranslation(l),m=r.right;(0,E.rotateAroundAxis)(r,-t,m,h,c)})},normalizeView:function(view,e=0){const t=view.getResolution();view.setRotation(e),view.setResolution(view.constrainResolution(t))},isCesiumProjection:function(e){const t=e===Object(r.get)("EPSG:3857"),n=e===Object(r.get)("EPSG:4326");return t||n}};var O=E;var A=class{constructor(e){this.ol3d=e,this.scene_=e.getCesiumScene(),this.canvas_=this.scene_.canvas,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.repaintEventNames_=["mousemove","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove","wheel"],this.enable()}enable(){this.scene_.requestRenderMode=!0,this.scene_.maximumRenderTimeChange=1e3;for(const e of this.repaintEventNames_)this.canvas_.addEventListener(e,this._boundNotifyRepaintRequired,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().on("change",this._boundNotifyRepaintRequired)}disable(){for(const e of this.repaintEventNames_)this.canvas_.removeEventListener(e,this._boundNotifyRepaintRequired,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().un("change",this._boundNotifyRepaintRequired),this.scene_.requestRenderMode=!1}restartRenderLoop(){this.notifyRepaintRequired()}notifyRepaintRequired(){this.scene_.requestRender()}},G=n(133);function x(e){return 180*e/Math.PI}function M(e){return e*Math.PI/180}class F{constructor(e,map){this.scene_=e,this.cam_=e.camera,this.map_=map,this.view_=null,this.viewListenKey_=null,this.toLonLat_=F.identityProjection,this.fromLonLat_=F.identityProjection,this.tilt_=0,this.distance_=0,this.lastCameraViewMatrix_=null,this.viewUpdateInProgress_=!1,this.map_.on("change:view",e=>{this.setView_(this.map_.getView())}),this.setView_(this.map_.getView())}static identityProjection(input,e,t){const n=t||input.length;if(e)for(let i=0;i<n;++i)e[i]=input[i];return input}setView_(view){if(this.view_&&(Object(G.b)(this.viewListenKey_),this.viewListenKey_=null),this.view_=view,view){const e=Object(r.getTransform)(view.getProjection(),"EPSG:4326"),t=Object(r.getTransform)("EPSG:4326",view.getProjection());console.assert(e&&t),this.toLonLat_=e,this.fromLonLat_=t,this.viewListenKey_=view.on("propertychange",e=>this.handleViewEvent_(e)),this.readFromView()}else this.toLonLat_=F.identityProjection,this.fromLonLat_=F.identityProjection}handleViewEvent_(e){this.viewUpdateInProgress_||this.readFromView()}setHeading(e){this.view_&&this.view_.setRotation(e)}getHeading(){if(!this.view_)return;return this.view_.getRotation()||0}setTilt(e){this.tilt_=e,this.updateCamera_()}getTilt(){return this.tilt_}setDistance(e){this.distance_=e,this.updateCamera_(),this.updateView()}getDistance(){return this.distance_}setCenter(e){this.view_&&this.view_.setCenter(e)}getCenter(){if(this.view_)return this.view_.getCenter()}setPosition(e){if(!this.toLonLat_)return;const t=this.toLonLat_(e);console.assert(t);const n=new Cesium.Cartographic(M(t[0]),M(t[1]),this.getAltitude());this.cam_.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)}),this.updateView()}getPosition(){if(!this.fromLonLat_)return;const e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position),t=this.fromLonLat_([x(e.longitude),x(e.latitude)]);return console.assert(t),t}setAltitude(e){const t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);t.height=e,this.cam_.position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(t),this.updateView()}getAltitude(){return Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position).height}updateCamera_(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(!e)return;const t=this.toLonLat_(e);console.assert(t);const n=new Cesium.Cartographic(M(t[0]),M(t[1]));if(this.scene_.globe){const e=this.scene_.globe.getHeight(n);n.height=e||0}const o=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n),r={pitch:this.tilt_-Cesium.Math.PI_OVER_TWO,heading:-this.view_.getRotation(),roll:void 0};this.cam_.setView({destination:o,orientation:r}),this.cam_.moveBackward(this.distance_),this.checkCameraChange(!0)}readFromView(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(null==e)return;const t=this.toLonLat_(e);console.assert(t);const n=this.view_.getResolution();this.distance_=this.calcDistanceForResolution(n||0,M(t[1])),this.updateCamera_()}updateView(){if(!this.view_||!this.fromLonLat_)return;this.viewUpdateInProgress_=!0;const e=Cesium.Ellipsoid.WGS84,t=this.scene_,n=O.pickCenterPoint(t);let o=n;if(!o){const e=t.globe,n=this.cam_.positionCartographic.clone(),r=e.getHeight(n);n.height=r||0,o=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n)}this.distance_=Cesium.Cartesian3.distance(o,this.cam_.position);const r=e.cartesianToCartographic(o);if(this.view_.setCenter(this.fromLonLat_([x(r.longitude),x(r.latitude)])),this.view_.setResolution(this.calcResolutionForDistance(this.distance_,r?r.latitude:0)),n){const t=this.cam_.position,o=new Cesium.Cartesian3;e.geocentricSurfaceNormal(n,o);const r=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(t,n,r),Cesium.Cartesian3.normalize(r,r);const l=this.cam_.up,c=this.cam_.right,h=new Cesium.Cartesian3(-n.y,n.x,0),m=Cesium.Cartesian3.angleBetween(c,h),d=Cesium.Cartesian3.cross(n,l,new Cesium.Cartesian3).z;this.view_.setRotation(d<0?m:-m);const C=Math.acos(Cesium.Cartesian3.dot(o,r));this.tilt_=isNaN(C)?0:C}else this.view_.setRotation(this.cam_.heading),this.tilt_=-this.cam_.pitch+Math.PI/2;this.viewUpdateInProgress_=!1}checkCameraChange(e){const t=this.lastCameraViewMatrix_,n=this.cam_.viewMatrix;t&&Cesium.Matrix4.equalsEpsilon(t,n,1e-5)||(this.lastCameraViewMatrix_=n.clone(),!0!==e&&this.updateView())}calcDistanceForResolution(e,t){const canvas=this.scene_.canvas,n=this.cam_.frustum.fovy;console.assert(!isNaN(n));const o=this.view_.getProjection().getMetersPerUnit();return e*canvas.clientHeight*o*Math.cos(Math.abs(t))/2/Math.tan(n/2)}calcResolutionForDistance(e,t){const canvas=this.scene_.canvas,n=this.cam_.frustum.fovy,o=this.view_.getProjection().getMetersPerUnit();return 2*e*Math.tan(n/2)/o/Math.cos(Math.abs(t))/canvas.clientHeight}}var I=F,k=n(174);var V=class{constructor(map,e){this.map=map,this.view=map.getView(),this.scene=e,this.olLayers=map.getLayerGroup().getLayers(),this.mapLayerGroup=map.getLayerGroup(),this.layerMap={},this.olLayerListenKeys={},this.olGroupListenKeys_={}}synchronize(){this.destroyAll(),this.addLayers_(this.mapLayerGroup)}orderLayers(){}addLayers_(e){const t=[{layer:e,parents:[]}];for(;t.length>0;){const e=t.splice(0,1)[0],n=e.layer,o=m(n).toString();this.olLayerListenKeys[o]=[],console.assert(!this.layerMap[o]);let r=null;if(n instanceof k.a)this.listenForGroupChanges_(n),n!==this.mapLayerGroup&&(r=this.createSingleLayerCounterparts(e)),r||n.getLayers().forEach(o=>{if(o){const r={layer:o,parents:n===this.mapLayerGroup?[]:[e.layer].concat(e.parents)};t.push(r)}});else if(!(r=this.createSingleLayerCounterparts(e))){const t=o,n=e,r=e=>{const o=this.createSingleLayerCounterparts(n);o&&(n.layer.un("change",r),this.addCesiumObjects_(o,t,n.layer),this.orderLayers())};this.olLayerListenKeys[o].push(c(n.layer,"change",r))}r&&this.addCesiumObjects_(r,o,n)}this.orderLayers()}addCesiumObjects_(e,t,n){this.layerMap[t]=e,this.olLayerListenKeys[t].push(c(n,"change:zIndex",()=>this.orderLayers())),e.forEach(e=>{this.addCesiumObject(e)})}removeAndDestroySingleLayer_(e){const t=m(e).toString(),n=this.layerMap[t];return n&&(n.forEach(e=>{this.removeSingleCesiumObject(e,!1),this.destroyCesiumObject(e)}),this.olLayerListenKeys[t].forEach(G.b),delete this.olLayerListenKeys[t]),delete this.layerMap[t],!!n}unlistenSingleGroup_(e){if(e===this.mapLayerGroup)return;const t=m(e).toString();this.olGroupListenKeys_[t].forEach(e=>{Object(G.b)(e)}),delete this.olGroupListenKeys_[t],delete this.layerMap[t]}removeLayer_(e){if(e){const t=[e];for(;t.length>0;){const e=t.splice(0,1)[0],n=this.removeAndDestroySingleLayer_(e);e instanceof k.a&&(this.unlistenSingleGroup_(e),n||e.getLayers().forEach(e=>{t.push(e)}))}}}listenForGroupChanges_(e){const t=m(e).toString();console.assert(void 0===this.olGroupListenKeys_[t]);const n=[];this.olGroupListenKeys_[t]=n;let o=[];const r=function(){const t=e.getLayers();t&&(o=[t.on("add",e=>{this.addLayers_(e.element)}),t.on("remove",e=>{this.removeLayer_(e.element)})],n.push(...o))}.bind(this);r(),n.push(e.on("change:layers",e=>{o.forEach(e=>{const i=n.indexOf(e);i>=0&&n.splice(i,1),Object(G.b)(e)}),r()}))}destroyAll(){let e;for(e in this.removeAllCesiumObjects(!0),this.olGroupListenKeys_)this.olGroupListenKeys_[e].forEach(G.b);for(e in this.olLayerListenKeys)this.olLayerListenKeys[e].forEach(G.b);this.olGroupListenKeys_={},this.olLayerListenKeys={},this.layerMap={}}addCesiumObject(object){}destroyCesiumObject(object){}removeSingleCesiumObject(object,e){}removeAllCesiumObjects(e){}createSingleLayerCounterparts(e){}};var j=class extends V{constructor(map,e){super(map,e),this.cesiumLayers_=e.imageryLayers,this.ourLayers_=new Cesium.ImageryLayerCollection}addCesiumObject(object){this.cesiumLayers_.add(object),this.ourLayers_.add(object)}destroyCesiumObject(object){object.destroy()}removeSingleCesiumObject(object,e){this.cesiumLayers_.remove(object,e),this.ourLayers_.remove(object,!1)}removeAllCesiumObjects(e){for(let i=0;i<this.ourLayers_.length;++i)this.cesiumLayers_.remove(this.ourLayers_.get(i),e);this.ourLayers_.removeAll(!1)}convertLayerToCesiumImageries(e,t){const n=O.tileLayerToImageryLayer(this.map,e,t);return n?[n]:null}createSingleLayerCounterparts(e){const t=e.layer,n=m(t).toString(),o=this.view.getProjection();console.assert(o);const r=this.convertLayerToCesiumImageries(t,o);if(r){const o=[];[e.layer].concat(e.parents).forEach(t=>{o.push(t.on(["change:opacity","change:visible"],()=>{console.assert(r);for(let i=0;i<r.length;++i)O.updateCesiumLayerProperties(e,r[i])}))});for(let i=0;i<r.length;++i)O.updateCesiumLayerProperties(e,r[i]);o.push(t.on("change:extent",e=>{for(let i=0;i<r.length;++i)this.cesiumLayers_.remove(r[i],!0),this.ourLayers_.remove(r[i],!1);delete this.layerMap[m(t)],this.synchronize()})),o.push(t.on("change",e=>{for(let i=0;i<r.length;++i){const e=this.cesiumLayers_.indexOf(r[i]);e>=0&&(this.cesiumLayers_.remove(r[i],!1),this.cesiumLayers_.add(r[i],e))}})),this.olLayerListenKeys[n].push(...o)}return Array.isArray(r)?r:null}orderLayers(){const e=[],t={},n=[this.mapLayerGroup];for(;n.length>0;){const o=n.splice(0,1)[0];if(e.push(o),t[m(o)]=o.getZIndex(),o instanceof k.a){const e=o.getLayers();e&&n.unshift(...e.getArray())}}!function(e,t){const n=e.length,o=Array(e.length);for(let i=0;i<n;i++)o[i]={index:i,value:e[i]};o.sort((a,b)=>t(a.value,b.value)||a.index-b.index);for(let i=0;i<e.length;i++)e[i]=o[i].value}(e,(e,n)=>t[m(e)]-t[m(n)]),e.forEach(e=>{const t=m(e).toString(),n=this.layerMap[t];n&&n.forEach(e=>{this.raiseToTop(e)})})}raiseToTop(e){this.cesiumLayers_.raiseToTop(e)}},N=n(75),D=n(67),H=n(254),z=n(58),U=n(259),B=n(142),W=n(189),K=n(38),Z=n(0),Q=n(51);var Y=class{constructor(e,t){const n=new Cesium.BillboardCollection({scene:t}),o=new Cesium.PrimitiveCollection;this.olListenKeys=[],this.rootCollection_=new Cesium.PrimitiveCollection,this.context={projection:e,billboards:n,featureToCesiumMap:{},primitives:o},this.rootCollection_.add(n),this.rootCollection_.add(o)}destroy(){this.olListenKeys.forEach(G.b),this.olListenKeys.length=0}getRootPrimitive(){return this.rootCollection_}};var $=class{constructor(e){this.scene=e,this.boundOnRemoveOrClearFeatureListener_=this.onRemoveOrClearFeature_.bind(this),this.defaultBillboardEyeOffset_=new Cesium.Cartesian3(0,0,10)}onRemoveOrClearFeature_(e){const source=e.target;console.assert(source instanceof N.a);const t=C.obj(source).olcs_cancellers;if(t){const n=e.feature;if(n){const e=m(n),o=t[e];o&&(o(),delete t[e])}else{for(const e in t)t.hasOwnProperty(e)&&t[e]();C.obj(source).olcs_cancellers={}}}}setReferenceForPicking(e,t,n){n.olLayer=e,n.olFeature=t}createColoredPrimitive(e,t,n,o,r,l){const c={flat:!0,renderState:{depthTest:{enabled:!0}}};void 0!==l&&(c.renderState||(c.renderState={}),c.renderState.lineWidth=l);const h=function(e,t){const n=new Cesium.GeometryInstance({geometry:e});return!t||t instanceof Cesium.ImageMaterialProperty||(n.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(t)}),n}(o,r);let m;if(this.getHeightReference(e,t,n)===Cesium.HeightReference.CLAMP_TO_GROUND){const e=h.geometry.constructor;if(e&&!e.createShadowVolume)return null;m=new Cesium.GroundPrimitive({geometryInstances:h})}else m=new Cesium.Primitive({geometryInstances:h});if(r instanceof Cesium.ImageMaterialProperty){const e=r.image.getValue().toDataURL();m.appearance=new Cesium.MaterialAppearance({flat:!0,renderState:{depthTest:{enabled:!0}},material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:e}}})})}else m.appearance=new Cesium.PerInstanceColorAppearance(c);return this.setReferenceForPicking(e,t,m),m}extractColorFromOlStyle(style,e){const t=style.getFill()?style.getFill().getColor():null,n=style.getStroke()?style.getStroke().getColor():null;let o="black";return n&&e?o=n:t&&(o=t),O.convertColorToCesium(o)}extractLineWidthFromOlStyle(style){const e=style.getStroke()?style.getStroke().getWidth():void 0;return void 0!==e?e:1}wrapFillAndOutlineGeometries(e,t,n,o,r,l){const c=this.extractColorFromOlStyle(l,!1),h=this.extractColorFromOlStyle(l,!0),m=new Cesium.PrimitiveCollection;if(l.getFill()){const r=this.createColoredPrimitive(e,t,n,o,c);console.assert(!!r),m.add(r)}if(l.getStroke()&&r){const o=this.extractLineWidthFromOlStyle(l),c=this.createColoredPrimitive(e,t,n,r,h,o);c&&m.add(c)}return m}addTextStyle(e,t,n,style,o){let r;if(o instanceof Cesium.PrimitiveCollection?r=o:(r=new Cesium.PrimitiveCollection).add(o),!style.getText())return r;const text=style.getText(),label=this.olGeometry4326TextPartToCesium(e,t,n,text);return label&&r.add(label),r}csAddBillboard(e,t,n,o,r,style){t.eyeOffset||(t.eyeOffset=this.defaultBillboardEyeOffset_);const l=e.add(t);return this.setReferenceForPicking(n,o,l),l}olCircleGeometryToCesium(e,t,n,o,r){n=O.olGeometryCloneTo4326(n,o),console.assert("Circle"==n.getType());let l=n.getCenter();const c=3==l.length?l[2]:0;let h=l.slice();h[0]+=n.getRadius(),l=O.ol4326CoordinateToCesiumCartesian(l),h=O.ol4326CoordinateToCesiumCartesian(h);const m=Cesium.Cartesian3.distance(l,h),C=new Cesium.CircleGeometry({center:l,radius:m,height:c});let _,y;if(this.getHeightReference(e,t,n)===Cesium.HeightReference.CLAMP_TO_GROUND){const o=this.extractLineWidthFromOlStyle(r);if(o){const l=Object(K.a)(n.getCenter(),m),c=O.ol4326CoordinateArrayToCsCartesians(l.getLinearRing(0).getCoordinates());if(d(this.scene))(_=new Cesium.GroundPolylinePrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.GroundPolylineGeometry({positions:c,width:o})}),appearance:new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,r,!0)}),classificationType:Cesium.ClassificationType.TERRAIN})).readyPromise.then(()=>{this.setReferenceForPicking(e,t,_._primitive)});else{const n=this.extractColorFromOlStyle(r,!0);_=this.createStackedGroundCorridors(e,t,o,n,c)}}}else y=new Cesium.CircleOutlineGeometry({center:l,radius:m,extrudedHeight:c,height:c});const f=this.wrapFillAndOutlineGeometries(e,t,n,C,y,r);return _&&f.add(_),this.addTextStyle(e,t,n,r,f)}createStackedGroundCorridors(e,t,n,o,r){Array.isArray(r[0])||(r=[r]),n=Math.max(3,n);const l=[];let c=0;for(const e of[1e3,4e3,16e3,64e3,254e3,1e6,1e7]){const t={width:n*=2.14,vertexFormat:Cesium.VertexFormat.POSITION_ONLY};for(const n of r)t.positions=n,l.push(new Cesium.GeometryInstance({geometry:new Cesium.CorridorGeometry(t),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(o),distanceDisplayCondition:new Cesium.DistanceDisplayConditionGeometryInstanceAttribute(c,e-1)}}));c=e}return new Cesium.GroundPrimitive({geometryInstances:l})}olLineStringGeometryToCesium(e,t,n,o,r){n=O.olGeometryCloneTo4326(n,o),console.assert("LineString"==n.getType());const l=O.ol4326CoordinateArrayToCsCartesians(n.getCoordinates()),c=this.extractLineWidthFromOlStyle(r);let h;const m=this.getHeightReference(e,t,n);if(m!==Cesium.HeightReference.CLAMP_TO_GROUND||d(this.scene)){const n=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,r,!0)}),o={positions:l,width:c},d={appearance:n};if(m===Cesium.HeightReference.CLAMP_TO_GROUND){const n=new Cesium.GroundPolylineGeometry(o);d.geometryInstances=new Cesium.GeometryInstance({geometry:n}),(h=new Cesium.GroundPolylinePrimitive(d)).readyPromise.then(()=>{this.setReferenceForPicking(e,t,h._primitive)})}else{o.vertexFormat=n.vertexFormat;const e=new Cesium.PolylineGeometry(o);d.geometryInstances=new Cesium.GeometryInstance({geometry:e}),h=new Cesium.Primitive(d)}}else{const n=this.extractColorFromOlStyle(r,!0);h=this.createStackedGroundCorridors(e,t,c,n,l)}return this.setReferenceForPicking(e,t,h),this.addTextStyle(e,t,n,r,h)}olPolygonGeometryToCesium(e,t,n,o,r){n=O.olGeometryCloneTo4326(n,o),console.assert("Polygon"==n.getType());const l=this.getHeightReference(e,t,n);let c,h,m;if(5==n.getCoordinates()[0].length&&"rectangle"===t.getGeometry().get("olcs.polygon_kind")){const e=n.getCoordinates()[0],t=Object(Z.b)(e),o=Cesium.Rectangle.fromDegrees(t[0],t[1],t[2],t[3]);let r=0;if(3==e[0].length)for(let t=0;t<e.length;t++)r=Math.max(r,e[t][2]);c=new Cesium.RectangleGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:o,height:r}),h=new Cesium.RectangleOutlineGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:o,height:r})}else{const o=n.getLinearRings(),C={},_=C;console.assert(o.length>0);for(let i=0;i<o.length;++i){const e=o[i].getCoordinates(),t=O.ol4326CoordinateArrayToCsCartesians(e);console.assert(t&&t.length>0),0==i?C.positions=t:(C.holes||(C.holes=[]),C.holes.push({positions:t}))}if(c=new Cesium.PolygonGeometry({polygonHierarchy:_,perPositionHeight:!0}),l===Cesium.HeightReference.CLAMP_TO_GROUND){const n=this.extractLineWidthFromOlStyle(r);if(n>0){const o=[C.positions];if(C.holes)for(let i=0;i<C.holes.length;++i)o.push(C.holes[i].positions);if(d(this.scene)){const l=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,r,!0)}),c=[];for(const e of o){const t=new Cesium.GroundPolylineGeometry({positions:e,width:n});c.push(new Cesium.GeometryInstance({geometry:t}))}const h={appearance:l,geometryInstances:c};(m=new Cesium.GroundPolylinePrimitive(h)).readyPromise.then(()=>{this.setReferenceForPicking(e,t,m._primitive)})}else{const l=this.extractColorFromOlStyle(r,!0);m=this.createStackedGroundCorridors(e,t,n,l,o)}}}else h=new Cesium.PolygonOutlineGeometry({polygonHierarchy:C,perPositionHeight:!0})}const C=this.wrapFillAndOutlineGeometries(e,t,n,c,h,r);return m&&C.add(m),this.addTextStyle(e,t,n,r,C)}getHeightReference(e,t,n){let o=n.get("altitudeMode");void 0===o&&(o=t.get("altitudeMode")),void 0===o&&(o=e.get("altitudeMode"));let r=Cesium.HeightReference.NONE;return"clampToGround"===o?r=Cesium.HeightReference.CLAMP_TO_GROUND:"relativeToGround"===o&&(r=Cesium.HeightReference.RELATIVE_TO_GROUND),r}createBillboardFromImage(e,t,n,o,style,r,l,c){r instanceof W.a&&r.load();const image=r.getImage(1),h=function(){if(!image)return;if(!(image instanceof HTMLCanvasElement||image instanceof Image||image instanceof HTMLImageElement))return;const o=n.getCoordinates(),h=O.ol4326CoordinateToCesiumCartesian(o);let m;const d=r.getOpacity();void 0!==d&&(m=new Cesium.Color(1,1,1,d));const C=this.getHeightReference(e,t,n),_={image:image,color:m,scale:r.getScale(),heightReference:C,position:h};if(r instanceof W.a){const e=r.getAnchor();e&&(_.pixelOffset=new Cesium.Cartesian2(image.width/2-e[0],image.height/2-e[1]))}const y=this.csAddBillboard(l,_,e,t,n,style);c&&c(y)}.bind(this);if(image instanceof Image&&!function(image){return""!=image.src&&0!=image.naturalHeight&&0!=image.naturalWidth&&image.complete}(image)){let n=!1;const source=e.getSource(),o=function(){n=!0};source.on(["removefeature","clear"],this.boundOnRemoveOrClearFeatureListener_);let r=C.obj(source).olcs_cancellers;r||(r=C.obj(source).olcs_cancellers={});const c=m(t);r[c]&&r[c](),r[c]=o;const d=function(){image.removeEventListener("load",d),l.isDestroyed()||n||h()};image.addEventListener("load",d)}else h()}olPointGeometryToCesium(e,t,n,o,style,r,l){console.assert("Point"==n.getType()),n=O.olGeometryCloneTo4326(n,o);let c=null;const h=style.getImage();if(h){const m=n.get("olcs_model")||t.get("olcs_model");if(m){const e=m(),t=Object.assign({},{scene:this.scene},e.cesiumOptions),n=Cesium.Model.fromGltf(t);(c=new Cesium.PrimitiveCollection).add(n),e.debugModelMatrix&&c.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:e.debugModelMatrix}))}else this.createBillboardFromImage(e,t,n,o,style,h,r,l)}return style.getText()?this.addTextStyle(e,t,n,style,c||new Cesium.Primitive):c}olMultiGeometryToCesium(e,t,n,o,r,l,c){const h=function(n,l){const c=new Cesium.PrimitiveCollection;return n.forEach(n=>{c.add(l(e,t,n,o,r))}),c};let m;switch(n.getType()){case"MultiPoint":if(m=(n=n).getPoints(),r.getText()){const n=new Cesium.PrimitiveCollection;return m.forEach(h=>{console.assert(h);const m=this.olPointGeometryToCesium(e,t,h,o,r,l,c);m&&n.add(m)}),n}return m.forEach(n=>{console.assert(n),this.olPointGeometryToCesium(e,t,n,o,r,l,c)}),null;case"MultiLineString":return h(m=(n=n).getLineStrings(),this.olLineStringGeometryToCesium.bind(this));case"MultiPolygon":return h(m=(n=n).getPolygons(),this.olPolygonGeometryToCesium.bind(this));default:console.assert(!1,`Unhandled multi geometry type${n.getType()}`)}}olGeometry4326TextPartToCesium(e,t,n,style){const text=style.getText();if(!text)return null;const o=new Cesium.LabelCollection({scene:this.scene}),r=Object(Z.x)(n.getExtent());if(n instanceof Q.a){const e=n.getFirstCoordinate();r[2]=3==e.length?e[2]:0}const l={};l.position=O.ol4326CoordinateToCesiumCartesian(r),l.text=text,l.heightReference=this.getHeightReference(e,t,n);const c=style.getOffsetX(),h=style.getOffsetY();if(0!=c&&0!=h){const e=new Cesium.Cartesian2(c,h);l.pixelOffset=e}l.font=style.getFont()||"10px sans-serif";let m,d=void 0;switch(style.getFill()&&(l.fillColor=this.extractColorFromOlStyle(style,!1),d=Cesium.LabelStyle.FILL),style.getStroke()&&(l.outlineWidth=this.extractLineWidthFromOlStyle(style),l.outlineColor=this.extractColorFromOlStyle(style,!0),d=Cesium.LabelStyle.OUTLINE),style.getFill()&&style.getStroke()&&(d=Cesium.LabelStyle.FILL_AND_OUTLINE),l.style=d,style.getTextAlign()){case"left":m=Cesium.HorizontalOrigin.LEFT;break;case"right":m=Cesium.HorizontalOrigin.RIGHT;break;case"center":default:m=Cesium.HorizontalOrigin.CENTER}if(l.horizontalOrigin=m,style.getTextBaseline()){let e;switch(style.getTextBaseline()){case"top":e=Cesium.VerticalOrigin.TOP;break;case"middle":e=Cesium.VerticalOrigin.CENTER;break;case"bottom":e=Cesium.VerticalOrigin.BOTTOM;break;case"alphabetic":e=Cesium.VerticalOrigin.TOP;break;case"hanging":e=Cesium.VerticalOrigin.BOTTOM;break;default:console.assert(!1,`unhandled baseline ${style.getTextBaseline()}`)}l.verticalOrigin=e}const C=o.add(l);return this.setReferenceForPicking(e,t,C),o}olStyleToCesium(e,style,t){const n=style.getFill(),o=style.getStroke();if(t&&!o||!t&&!n)return null;let r=t?o.getColor():n.getColor();return r=O.convertColorToCesium(r),t&&o.getLineDash()?Cesium.Material.fromType("Stripe",{horizontal:!1,repeat:500,evenColor:r,oddColor:new Cesium.Color(0,0,0,0)}):Cesium.Material.fromType("Color",{color:r})}computePlainStyle(e,t,n,o){const r=t.getStyleFunction();let style=null;return r&&(style=r(t,o)),!style&&n&&(style=n(t,o)),style?Array.isArray(style)?style:[style]:null}getGeometryFromFeature(e,style,t){if(t)return t;const n=e.get("olcs.3d_geometry");if(n&&n instanceof B.a)return n;if(style){const t=style.getGeometryFunction()(e);if(t instanceof B.a)return t}return e.getGeometry()}olFeatureToCesium(e,t,style,n,o){let r=this.getGeometryFromFeature(t,style,o);if(!r)return null;const l=n.projection,c=function(e){const o=n.featureToCesiumMap[m(t)];o instanceof Array?o.push(e):n.featureToCesiumMap[m(t)]=[e]};switch(r.getType()){case"GeometryCollection":const o=new Cesium.PrimitiveCollection;return r.getGeometries().forEach(r=>{if(r){const l=this.olFeatureToCesium(e,t,style,n,r);l&&o.add(l)}}),o;case"Point":r=r;const h=n.billboards,m=this.olPointGeometryToCesium(e,t,r,l,style,h,c);return m||null;case"Circle":return r=r,this.olCircleGeometryToCesium(e,t,r,l,style);case"LineString":return r=r,this.olLineStringGeometryToCesium(e,t,r,l,style);case"Polygon":return r=r,this.olPolygonGeometryToCesium(e,t,r,l,style);case"MultiPoint":case"MultiLineString":case"MultiPolygon":const d=this.olMultiGeometryToCesium(e,t,r,l,style,n.billboards,c);return d||null;case"LinearRing":throw new Error("LinearRing should only be part of polygon.");default:throw new Error(`Ol geom type not handled : ${r.getType()}`)}}olVectorLayerToCesium(e,t,n){const o=t.getProjection(),r=t.getResolution();if(void 0===r||!o)throw console.assert(!1,"View not ready"),new Error("View not ready");let source=e.getSource();source instanceof H.a&&(source=source.getSource()),console.assert(source instanceof N.a);const l=source.getFeatures(),c=new Y(o,this.scene),h=c.context;for(let i=0;i<l.length;++i){const t=l[i];if(!t)continue;const o=e.getStyleFunction(),d=this.computePlainStyle(e,t,o,r);if(!d||!d.length)continue;let C=null;for(let i=0;i<d.length;i++){const n=this.olFeatureToCesium(e,t,d[i],h);if(n)if(C){if(n){let e,i=0;for(;e=n.get(i);)C.add(e),i++}}else C=n}C&&(n[m(t)]=C,c.getRootPrimitive().add(C))}return c}convert(e,view,t,n){const o=view.getProjection(),r=view.getResolution();if(null==r||!o)return null;const l=e.getStyleFunction(),c=this.computePlainStyle(e,t,l,r);if(!c.length)return null;n.projection=o;let h=null;for(let i=0;i<c.length;i++){const o=this.olFeatureToCesium(e,t,c[i],n);if(h){if(o){let e,i=0;for(;e=o.get(i);)h.add(e),i++}}else h=o}return h}};var J=class extends V{constructor(map,e,t){super(map,e),this.converter=t||new $(e),this.csAllPrimitives_=new Cesium.PrimitiveCollection,e.primitives.add(this.csAllPrimitives_),this.csAllPrimitives_.destroyPrimitives=!1}addCesiumObject(e){console.assert(e),e.getRootPrimitive().counterpart=e,this.csAllPrimitives_.add(e.getRootPrimitive())}destroyCesiumObject(object){object.getRootPrimitive().destroy()}removeSingleCesiumObject(object,e){object.destroy(),this.csAllPrimitives_.destroyPrimitives=e,this.csAllPrimitives_.remove(object.getRootPrimitive()),this.csAllPrimitives_.destroyPrimitives=!1}removeAllCesiumObjects(e){if(this.csAllPrimitives_.destroyPrimitives=e,e)for(let i=0;i<this.csAllPrimitives_.length;++i)this.csAllPrimitives_.get(i).counterpart.destroy();this.csAllPrimitives_.removeAll(),this.csAllPrimitives_.destroyPrimitives=!1}updateLayerVisibility(e,t){let n=!0;[e.layer].concat(e.parents).forEach(e=>{const t=e.getVisible();void 0!==t?n&=t:n=!1}),t.show=n}createSingleLayerCounterparts(e){const t=e.layer;if(!(t instanceof z.a)||t instanceof U.a)return null;console.assert(t instanceof D.a);let source=t.getSource();if(source instanceof H.a&&(source=source.getSource()),!source)return null;console.assert(source instanceof N.a),console.assert(this.view);const view=this.view,n={},o=this.converter.olVectorLayerToCesium(t,view,n),r=o.getRootPrimitive(),l=o.olListenKeys;[e.layer].concat(e.parents).forEach(t=>{l.push(c(t,"change:visible",()=>{this.updateLayerVisibility(e,r)}))}),this.updateLayerVisibility(e,r);const h=function(e){console.assert(t instanceof z.a||t instanceof f.a);const l=o.context,c=this.converter.convert(t,view,e,l);c&&(n[m(e)]=c,r.add(c))}.bind(this),d=function(e){const t=m(e),l=o.context,c=l.featureToCesiumMap[t];c&&(delete l.featureToCesiumMap[t],c.forEach(e=>{e instanceof Cesium.Billboard&&l.billboards.remove(e)}));const h=n[t];delete n[t],h&&r.remove(h)}.bind(this);return l.push(c(source,"addfeature",e=>{console.assert(e.feature),h(e.feature)})),l.push(c(source,"removefeature",e=>{console.assert(e.feature),d(e.feature)})),l.push(c(source,"changefeature",e=>{const t=e.feature;console.assert(t),d(t),h(t)})),o?[o]:null}},X=n(258);var ee=class extends X.a{constructor(e){const t=e.parent;super(t.getOptions()),this.scenePostRenderListenerRemover_=null,this.scene_=e.scene,this.synchronizer_=e.synchronizer,this.parent_=t,this.positionWGS84_=void 0,this.observer_=new MutationObserver(this.handleElementChanged.bind(this)),this.attributeObserver_=[],this.listenerKeys_=[];const n=e=>this.setPropertyFromEvent_(e);this.listenerKeys_.push(this.parent_.on("change:position",n)),this.listenerKeys_.push(this.parent_.on("change:element",n)),this.listenerKeys_.push(this.parent_.on("change:offset",n)),this.listenerKeys_.push(this.parent_.on("change:position",n)),this.listenerKeys_.push(this.parent_.on("change:positioning",n)),this.setProperties(this.parent_.getProperties()),this.handleMapChanged(),this.handleElementChanged()}observeTarget_(e){if(this.observer_){this.observer_.disconnect(),this.observer_.observe(e,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),this.attributeObserver_.forEach(e=>{e.disconnect()}),this.attributeObserver_.length=0;for(let i=0;i<e.childNodes.length;i++){const t=e.childNodes[i];if(1===t.nodeType){const e=new MutationObserver(this.handleElementChanged.bind(this));e.observe(t,{attributes:!0,subtree:!0}),this.attributeObserver_.push(e)}}}}setPropertyFromEvent_(e){e.target&&e.key&&this.set(e.key,e.target.get(e.key))}getScene(){return this.scene_}handleMapChanged(){var e;this.scenePostRenderListenerRemover_&&(this.scenePostRenderListenerRemover_(),(e=this.element)&&e.parentNode&&e.parentNode.removeChild(e)),this.scenePostRenderListenerRemover_=null;const t=this.getScene();if(t){this.scenePostRenderListenerRemover_=t.postRender.addEventListener(this.updatePixelPosition.bind(this)),this.updatePixelPosition();const e=this.stopEvent?this.synchronizer_.getOverlayContainerStopEvent():this.synchronizer_.getOverlayContainer();this.insertFirst?e.insertBefore(this.element,e.childNodes[0]||null):e.appendChild(this.element)}}handlePositionChanged(){const e=this.getPosition();if(e){const t=this.parent_.getMap().getView().getProjection();this.positionWGS84_=Object(r.transform)(e,t,"EPSG:4326")}else this.positionWGS84_=void 0;this.updatePixelPosition()}handleElementChanged(){function e(t,n){const o=t.cloneNode();n&&n.appendChild(o),t.nodeType!=Node.TEXT_NODE&&o.addEventListener("click",e=>{t.dispatchEvent(new MouseEvent("click",e)),e.stopPropagation()});const r=t.childNodes;for(let i=0;i<r.length;i++)r[i]&&e(r[i],o);return o}!function(e){for(;e.lastChild;)e.removeChild(e.lastChild)}(this.element);const element=this.getElement();if(element&&element.parentNode&&element.parentNode.childNodes)for(const t of element.parentNode.childNodes){const n=e(t,null);this.element.appendChild(n)}element.parentNode&&this.observeTarget_(element.parentNode)}updatePixelPosition(){const e=this.positionWGS84_;if(!this.scene_||!e)return void this.setVisible(!1);let t=0;if(2===e.length){const n=this.scene_.globe.getHeight(Cesium.Cartographic.fromDegrees(e[0],e[1]));n&&this.scene_.globe.tilesLoaded&&(e[2]=n),n&&(t=n)}else t=e[2];const n=Cesium.Cartesian3.fromDegrees(e[0],e[1],t),o=this.scene_.camera,r=new Cesium.BoundingSphere(new Cesium.Cartesian3,6356752);if(!new Cesium.Occluder(r,o.position).isPointVisible(n))return void this.setVisible(!1);if(1!==o.frustum.computeCullingVolume(o.position,o.direction,o.up).computeVisibility(new Cesium.BoundingSphere(n)))return void this.setVisible(!1);this.setVisible(!0);const l=this.scene_.cartesianToCanvasCoordinates(n),c=[l.x,l.y],h=[this.scene_.canvas.width,this.scene_.canvas.height];this.updateRenderedPosition(c,h)}destroy(){this.scenePostRenderListenerRemover_&&this.scenePostRenderListenerRemover_(),this.observer_&&this.observer_.disconnect(),Object(G.b)(this.listenerKeys_),this.listenerKeys_.splice(0),this.element.removeNode?this.element.removeNode(!0):this.element.remove(),this.element=null}};var te=class{constructor(map,e){this.map=map,this.overlays_=this.map.getOverlays(),this.scene=e,this.overlayContainerStopEvent_=document.createElement("DIV"),this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",["click","dblclick","mousedown","touchstart","MSPointerDown","pointerdown","mousewheel","wheel"].forEach(e=>{this.overlayContainerStopEvent_.addEventListener(e,e=>e.stopPropagation())}),this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_),this.overlayContainer_=document.createElement("DIV"),this.overlayContainer_.className="ol-overlaycontainer",this.scene.canvas.parentElement.appendChild(this.overlayContainer_),this.overlayMap_={}}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOverlayContainer(){return this.overlayContainer_}synchronize(){this.destroyAll(),this.addOverlays(),this.overlays_.on("add",this.addOverlayFromEvent_.bind(this)),this.overlays_.on("remove",this.removeOverlayFromEvent_.bind(this))}addOverlayFromEvent_(e){const t=e.element;this.addOverlay(t)}addOverlays(){this.overlays_.forEach(e=>{this.addOverlay(e)})}addOverlay(e){if(!e)return;const t=new ee({scene:this.scene,synchronizer:this,parent:e}),n=m(e).toString();this.overlayMap_[n]=t}removeOverlayFromEvent_(e){const t=e.element;this.removeOverlay(t)}removeOverlay(e){const t=m(e).toString(),n=this.overlayMap_[t];n&&(n.destroy(),delete this.overlayMap_[t])}destroyAll(){Object.keys(this.overlayMap_).forEach(e=>{this.overlayMap_[e].destroy(),delete this.overlayMap_[e]})}};class ie{constructor(e){this.autoRenderLoop_=null,this.map_=e.map,this.time_=e.time||function(){return Cesium.JulianDate.now()},this.to4326Transform_=Object(r.getTransform)(this.map_.getView().getProjection(),"EPSG:4326"),this.resolutionScale_=1,this.canvasClientWidth_=0,this.canvasClientHeight_=0,this.resolutionScaleChanged_=!0;const t="position:absolute;top:0;left:0;width:100%;height:100%;";this.container_=document.createElement("DIV");const n=document.createAttribute("style");n.value=`${t}visibility:hidden;`,this.container_.setAttributeNode(n);let o=e.target||null;if(o)"string"==typeof o&&(o=document.getElementById(o)),o.appendChild(this.container_);else{const e=this.map_.getViewport().querySelector(".ol-overlaycontainer");e&&e.parentNode&&e.parentNode.insertBefore(this.container_,e)}if(this.isOverMap_=!o,this.isOverMap_&&e.stopOpenLayersEventsPropagation){const e=["click","dblclick","mousedown","touchstart","MSPointerDown","pointerdown","mousewheel","wheel"];for(let i=0,t=e.length;i<t;++i)this.container_.addEventListener(e[i],e=>e.stopPropagation())}this.canvas_=document.createElement("CANVAS");const l=document.createAttribute("style");l.value=t,this.canvas_.setAttributeNode(l),C.supportsImageRenderingPixelated()&&(this.canvas_.style.imageRendering=C.imageRenderingValue()),this.canvas_.oncontextmenu=function(){return!1},this.canvas_.onselectstart=function(){return!1},this.container_.appendChild(this.canvas_),this.enabled_=!1,this.pausedInteractions_=[],this.hiddenRootGroup_=null;const c=void 0!==e.sceneOptions?e.sceneOptions:{};c.canvas=this.canvas_,c.scene3DOnly=!0,this.scene_=new Cesium.Scene(c);const h=this.scene_.screenSpaceCameraController;h.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.SHIFT}),h.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.ALT}),h.enableLook=!1,this.scene_.camera.constrainedAxis=Cesium.Cartesian3.UNIT_Z,this.camera_=new I(this.scene_,this.map_),this.globe_=new Cesium.Globe(Cesium.Ellipsoid.WGS84),this.globe_.baseColor=Cesium.Color.WHITE,this.scene_.globe=this.globe_,this.scene_.skyAtmosphere=new Cesium.SkyAtmosphere;const m=new Cesium.SingleTileImageryProvider({url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",rectangle:Cesium.Rectangle.fromDegrees(0,0,1,1)});this.globe_.imageryLayers.addImageryProvider(m,0),this.dataSourceCollection_=new Cesium.DataSourceCollection,this.dataSourceDisplay_=new Cesium.DataSourceDisplay({scene:this.scene_,dataSourceCollection:this.dataSourceCollection_});const d=e.createSynchronizers?e.createSynchronizers(this.map_,this.scene_,this.dataSourceCollection_):[new j(this.map_,this.scene_),new J(this.map_,this.scene_),new te(this.map_,this.scene_)];this.handleResize_();for(let i=d.length-1;i>=0;--i)d[i].synchronize();this.lastFrameTime_=0,this.renderId_=void 0,this.targetFrameRate_=Number.POSITIVE_INFINITY,this.blockCesiumRendering_=!1,this.warmingUp_=!1,this.trackedFeature_=null,this.trackedEntity_=null,this.entityView_=null,this.needTrackedEntityUpdate_=!1,this.boundingSphereScratch_=new Cesium.BoundingSphere,(new Cesium.EventHelper).add(this.scene_.postRender,ie.prototype.updateTrackedEntity_,this),Cesium.Camera.enableSuspendTerrainAdjustment=!1}render_(){void 0!==this.renderId_&&(cancelAnimationFrame(this.renderId_),this.renderId_=void 0),!this.enabled_&&!this.warmingUp_||this.blockCesiumRendering_||(this.renderId_=requestAnimationFrame(this.onAnimationFrame_.bind(this)))}onAnimationFrame_(e){this.renderId_=void 0;const t=1e3/this.targetFrameRate_;if(e-this.lastFrameTime_<t)return void this.render_();this.lastFrameTime_=e;const n=this.time_();if(this.scene_.initializeFrame(),this.handleResize_(),this.dataSourceDisplay_.update(n),this.entityView_){const e=this.trackedEntity_;this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_)===Cesium.BoundingSphereState.DONE&&(this.boundingSphereScratch_.radius=1,this.entityView_.update(n,this.boundingSphereScratch_))}this.scene_.render(n),this.camera_.checkCameraChange(),this.render_()}updateTrackedEntity_(){if(!this.needTrackedEntityUpdate_)return;const e=this.trackedEntity_,t=this.scene_,n=this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_);if(n===Cesium.BoundingSphereState.PENDING)return;t.screenSpaceCameraController.enableTilt=!1;const o=n!==Cesium.BoundingSphereState.FAILED?this.boundingSphereScratch_:void 0;o&&(o.radius=1),this.entityView_=new Cesium.EntityView(e,t,t.mapProjection.ellipsoid),this.entityView_.update(this.time_(),o),this.needTrackedEntityUpdate_=!1}handleResize_(){let e=this.canvas_.clientWidth,t=this.canvas_.clientHeight;if(0===e|0===t)return;if(e===this.canvasClientWidth_&&t===this.canvasClientHeight_&&!this.resolutionScaleChanged_)return;let n=this.resolutionScale_;C.supportsImageRenderingPixelated()||(n*=window.devicePixelRatio||1),this.resolutionScaleChanged_=!1,this.canvasClientWidth_=e,this.canvasClientHeight_=t,e*=n,t*=n,this.canvas_.width=e,this.canvas_.height=t,this.scene_.camera.frustum.aspectRatio=e/t}getCamera(){return this.camera_}getOlMap(){return this.map_}getOlView(){const view=this.map_.getView();return console.assert(view),view}getCesiumScene(){return this.scene_}getDataSources(){return this.dataSourceCollection_}getDataSourceDisplay(){return this.dataSourceDisplay_}getEnabled(){return this.enabled_}setEnabled(e){if(this.enabled_===e)return;let t;if(this.enabled_=e,this.container_.style.visibility=this.enabled_?"visible":"hidden",this.enabled_){if(this.throwOnUnitializedMap_(),this.isOverMap_){(t=this.map_.getInteractions()).forEach((e,i,t)=>{this.pausedInteractions_.push(e)}),t.clear(),this.map_.addInteraction=(e=>this.pausedInteractions_.push(e)),this.map_.removeInteraction=(e=>this.pausedInteractions_=this.pausedInteractions_.filter(i=>i!==e));const e=this.map_.getLayerGroup();e.getVisible()&&(this.hiddenRootGroup_=e,this.hiddenRootGroup_.setVisible(!1)),this.map_.getOverlayContainer().classList.add("olcs-hideoverlay"),this.map_.getOverlayContainerStopEvent().classList.add("olcs-hideoverlay")}this.camera_.readFromView(),this.render_()}else this.isOverMap_&&(t=this.map_.getInteractions(),this.pausedInteractions_.forEach(e=>{t.push(e)}),this.pausedInteractions_.length=0,this.map_.addInteraction=(e=>this.map_.getInteractions().push(e)),this.map_.removeInteraction=(e=>this.map_.getInteractions().remove(e)),this.map_.getOverlayContainer().classList.remove("olcs-hideoverlay"),this.map_.getOverlayContainerStopEvent().classList.remove("olcs-hideoverlay"),this.hiddenRootGroup_&&(this.hiddenRootGroup_.setVisible(!0),this.hiddenRootGroup_=null)),this.camera_.updateView()}warmUp(e,t){if(this.enabled_)return;this.throwOnUnitializedMap_(),this.camera_.readFromView();const n=this.globe_.ellipsoid,o=this.scene_.camera,r=n.cartesianToCartographic(o.position);r.height<e&&(r.height=e,o.position=n.cartographicToCartesian(r)),this.warmingUp_=!0,this.render_(),setTimeout(()=>{this.warmingUp_=!1},t)}setBlockCesiumRendering(e){this.blockCesiumRendering_!==e&&(this.blockCesiumRendering_=e,this.render_())}enableAutoRenderLoop(){this.autoRenderLoop_||(this.autoRenderLoop_=new A(this))}getAutoRenderLoop(){return this.autoRenderLoop_}setResolutionScale(e){(e=Math.max(0,e))!==this.resolutionScale_&&(this.resolutionScale_=Math.max(0,e),this.resolutionScaleChanged_=!0,this.autoRenderLoop_&&this.autoRenderLoop_.restartRenderLoop())}setTargetFrameRate(e){this.targetFrameRate_!==e&&(this.targetFrameRate_=e,this.render_())}throwOnUnitializedMap_(){const view=this.map_.getView(),e=view.getCenter();if(!view.isDef()||isNaN(e[0])||isNaN(e[1]))throw new Error(`The OpenLayers map is not properly initialized: ${e} / ${view.getResolution()}`)}}Object.defineProperties(ie.prototype,{trackedFeature:{get:function(){return this.trackedFeature_},set:function(e){if(this.trackedFeature_!==e){const t=this.scene_;if(!e||!e.getGeometry())return this.needTrackedEntityUpdate_=!1,t.screenSpaceCameraController.enableTilt=!0,this.trackedEntity_&&this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_),this.trackedEntity_=null,this.trackedFeature_=null,this.entityView_=null,void t.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);this.trackedFeature_=e,this.needTrackedEntityUpdate_=!0;const n=this.to4326Transform_,r=function(){const t=e.getGeometry();console.assert(t instanceof o.a);const r=t.getCoordinates(),l=n(r,void 0,r.length);return O.ol4326CoordinateToCesiumCartesian(l)},l={position:new Cesium.CallbackProperty((time,e)=>r(),!1),point:{pixelSize:1,color:Cesium.Color.TRANSPARENT}};this.trackedEntity_=this.dataSourceDisplay_.defaultDataSource.entities.add(l)}}}})}}]);